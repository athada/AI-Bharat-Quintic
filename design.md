# Design: Quintic — Kalyan Agent

## System Overview

Kalyan Agent is a proactive, voice-first AI agent delivered via WhatsApp that unifies government welfare access and ONDC marketplace onboarding for rural Indian households. The system uses a layered AWS architecture with durable orchestration, enabling long-running workflows that survive API timeouts, server crashes, and multi-day government response cycles.

### Design Principles

1. **Voice-First, Text-Optional:** Every interaction can be completed via voice in 22+ Indian dialects. Text is generated by the system, not required from the user.
2. **Async by Default:** The user sends a request and goes to the field. Processing happens on AWS cloud; results arrive as WhatsApp push notifications.
3. **Scan Once, Use Anywhere:** Documents are uploaded once to the Identity Vault and reused across all welfare applications, ONDC listings, and future services.
4. **Proactive, Not Reactive:** Unlike passive search engines (myScheme, JanSamarth), the agent monitors life events and policy changes to push eligibility alerts.
5. **Welfare-to-Wealth Continuum:** The system treats welfare and commerce as a unified journey, not separate silos.

---

## Architecture Overview

The system is organized into 5 layers:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 1: Edge & Access                                                 │
│  Amazon CloudFront (CDN) → AWS WAF (Firewall)                          │
│  Amazon Pinpoint (WhatsApp Gateway) → Amazon Cognito (Auth)            │
├─────────────────────────────────────────────────────────────────────────┤
│  Layer 2: Durable Orchestration                                         │
│  AWS Step Functions (Workflow Engine) → Amazon DynamoDB (Session State) │
│  Amazon EventBridge (Event Bus) → SQS DLQ (Dead Letter Queue)         │
├─────────────────────────────────────────────────────────────────────────┤
│  Layer 3: AI & Reasoning                                                │
│  Amazon Transcribe (Speech-to-Text) → Amazon Textract (ID OCR)        │
│  Amazon Bedrock / Claude Sonnet 4.5 (Brain) → Amazon Kendra (Policy RAG)│
├─────────────────────────────────────────────────────────────────────────┤
│  Layer 4: Integration                                                   │
│  AWS Lambda (Action Groups) → Amazon VPC (Private Network)             │
│  NAT Gateway (Secure Outbound) → AWS Secrets Manager (API Keys)       │
├─────────────────────────────────────────────────────────────────────────┤
│  Layer 5: External Ecosystem                                            │
│  Bhashini API (Translation) │ Govt Portals / myScheme / DBT            │
│  ONDC Seller Gateway │ NPCI / Bank Switch                              │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Layer Details

### Layer 1: Edge & Access

| Component | Service | Purpose |
|-----------|---------|---------|
| CDN & Caching | Amazon CloudFront | Serves static assets, reduces latency for media-heavy WhatsApp interactions |
| Web App Firewall | AWS WAF | Protects against DDoS, injection attacks, and malicious payloads |
| WhatsApp Gateway | Amazon Pinpoint | Manages inbound/outbound WhatsApp Business API messaging; supports text, images, voice notes, and interactive buttons |
| Authentication | Amazon Cognito | User pool management, session tokens, device-level auth for WhatsApp-linked identities |

**Design Decision:** WhatsApp was chosen as the sole interface because it is the only digital channel with near-universal penetration in rural India. No app installation, no browser required. The async nature of WhatsApp (user sends photo → goes to field → gets alert 1 hour later) matches rural work patterns.

### Layer 2: Durable Orchestration

| Component | Service | Purpose |
|-----------|---------|---------|
| Workflow Engine | AWS Step Functions | Manages the `Quintic_Core_Workflow` — a multi-phase, long-running state machine that orchestrates the entire user journey from onboarding to ONDC listing |
| Session State | Amazon DynamoDB | Persists workflow state, user profiles, document metadata, and application tracking IDs |
| Event Bus | Amazon EventBridge | Triggers re-evaluation of user eligibility when new schemes are published or policy criteria change |
| Error Handling | SQS Dead Letter Queue | Captures failed workflow executions for manual review and retry |

**Design Decision:** AWS Step Functions is the backbone because rural workflows are inherently long-running. A government API may take 3 days to respond. If a server crashes mid-workflow, Step Functions retries exactly where it left off. This durability is non-negotiable for welfare applications where a lost submission means a lost livelihood.

### Layer 3: AI & Reasoning

| Component | Service | Purpose |
|-----------|---------|---------|
| Speech-to-Text | Amazon Transcribe | Converts voice notes to text; paired with Bhashini API for dialect-specific accuracy across 22 Indian languages |
| Document OCR | Amazon Textract | Extracts structured fields (Name, DOB, Address, ID Number) from Aadhaar, PAN, and Bank passbook images — including low-quality, blurry photos |
| AI Brain | Amazon Bedrock (Claude Sonnet 4.5) | The reasoning engine: performs Document Diagnosis (cross-reference mismatch detection), translates legal policy language into simple dialect explanations, generates ONDC product catalogs from voice descriptions |
| Policy Search | Amazon Kendra | Enterprise RAG search engine indexing 5,000+ government scheme PDFs with contextual understanding of eligibility criteria |

**Design Decision:** We chose Amazon Kendra over standard vector search because government policy documents are dense, legalistic, and context-dependent. Kendra's enterprise search understands eligibility nuances (e.g., "weaver" + "UP state" + "BPL" → PM Hathkargha Yojana) better than embedding-based similarity search.

### Layer 4: Integration

| Component | Service | Purpose |
|-----------|---------|---------|
| Compute | AWS Lambda (Action Groups) | Serverless functions for: government portal API calls, ONDC catalog submission, correction form generation |
| Private Network | Amazon VPC | Isolates backend services; all government API calls route through a private subnet |
| Secure Outbound | NAT Gateway | Ensures outbound calls to government portals (myScheme, DBT) originate from static IPs for whitelisting |
| Secrets | AWS Secrets Manager | Stores and rotates API keys for Bhashini, ONDC Seller Gateway, NPCI, and government portal credentials |

### Layer 5: External Ecosystem

| System | Integration Type | Purpose |
|--------|-----------------|---------|
| Bhashini API | REST API | India's National Language Translation Mission — dialect translation for 22 languages (government-funded, free tier) |
| Govt Portals / myScheme | REST API + Screen Scraping | Auto-submission of welfare applications; status polling for tracking |
| ONDC Seller Gateway | ONDC Protocol API | Product catalog publishing, order management, settlement |
| NPCI / Bank Switch | UPI / IMPS API | DBT verification, bank account validation |

---

## Core Workflow: Quintic_Core_Workflow

The main state machine (`Quintic_Core_Workflow`) orchestrates 3 phases:

### Phase 1: Onboarding (Voice-First)

```
User (WhatsApp) → Voice Note → Pinpoint Gateway
  → Step Functions triggers workflow
    → Transcribe + Bhashini: audio → text
    → Bedrock Agent: extract intent (occupation, location, missing docs)
    → Reply via WhatsApp: "Namaste Ramesh ji. Please send photo of Aadhaar."
```

**Key Interaction:**
- Input: Voice note in any Indian language
- Processing: Transcription → Intent Analysis → Profile Creation
- Output: WhatsApp reply requesting identity documents
- State: `AWAITING_DOCUMENTS`

### Phase 2: The Document Doctor (Diagnosis)

```
User uploads Aadhaar + Bank Passbook → Pinpoint Gateway
  → Step Functions resumes workflow
    → Textract: Extract structured data (OCR)
    → Bedrock Agent: Cross-reference identity fields
      → IF mismatch detected:
          Alert user: "Name mismatch found: Ramesh Kumar vs Ramesh K."
          Auto-generate correction form
          State: WAIT_FOR_CORRECTION (durable pause)
      → IF verified:
          Proceed to Phase 3
```

**Document Health Report Generation:**
- System counts: Verified documents, Mismatched fields, Missing documents
- Individual status per document type: Aadhaar ✓ · PAN ✓ · Bank ✓ · Name Match ✗ · Caste Cert. ⚠
- Report delivered as structured WhatsApp message

**Mismatch Detection Logic:**
```
For each pair of documents (Aadhaar, PAN, Bank):
  Compare: Name (fuzzy match, threshold 85%)
  Compare: DOB (exact match)
  Compare: Address (fuzzy match, threshold 75%)
  If any field < threshold → FLAG as mismatch
  Generate correction form for the document with lowest match score
```

### Phase 3: The Dual Unlock (Parallel Execution)

Once documents are verified, two paths execute in parallel:

#### Path A — G2C: Welfare Unlocked
```
Bedrock Agent → Kendra: Query "Weaver Subsidy + UP State"
  → Match: "PM Hathkargha Yojana (₹10,000)"
  → Auto-fill application form from Identity Vault
  → User confirms via thumbprint
  → Lambda Action Group: Submit to government portal
  → Track: REF-UP-2026-4821
```

#### Path B — B2B: Commerce Unlocked
```
Bedrock Agent → Prompt user for product description (voice)
  → Transcribe + Bedrock: Generate ONDC catalog
    → Product JSON: {title, description, price, category}
  → Lambda Action Group: Publish to ONDC Seller Gateway
  → Confirm: "Your saree is LIVE on ONDC!"
```

#### Final Status Report
```
Voice Note: "Success! ₹10K applied AND your sarees are live on ONDC."
```

---

## Data Model

### User Profile (DynamoDB)

| Field | Type | Description |
|-------|------|-------------|
| `userId` | String (PK) | WhatsApp phone number hash |
| `name` | String | Extracted from Aadhaar |
| `occupation` | String | Inferred from voice onboarding |
| `location` | Object | `{state, district, village}` |
| `language` | String | Primary dialect detected |
| `documents` | Map | `{aadhaar: {status, data, s3Key}, pan: {...}, bank: {...}}` |
| `docHealthScore` | Object | `{verified: 3, mismatch: 1, missing: 1}` |
| `schemes` | List | `[{schemeId, name, amount, status, trackingId}]` |
| `ondcStore` | Object | `{sellerId, products: [...], totalRevenue, totalOrders}` |
| `createdAt` | Timestamp | Profile creation date |
| `lastActive` | Timestamp | Last WhatsApp interaction |

### Identity Vault (S3 + DynamoDB)

| Component | Storage | Purpose |
|-----------|---------|---------|
| Raw Document Images | S3 (encrypted, AES-256) | Original photos of Aadhaar, PAN, Bank passbook |
| Extracted Structured Data | DynamoDB | OCR output: Name, DOB, Address, ID numbers |
| Verification Metadata | DynamoDB | Match scores, mismatch flags, correction form status |

### Scheme Database (Amazon Kendra Index)

| Source | Format | Count |
|--------|--------|-------|
| Central Government Schemes | PDF, HTML | ~2,000 |
| State Government Schemes (28 states + 8 UTs) | PDF, HTML | ~3,000 |
| MSME / Artisan-specific Programs | PDF | ~500 |

---

## API Contracts

### WhatsApp Inbound Message (Pinpoint → Step Functions)

```json
{
  "messageId": "wamid.xxxx",
  "from": "+91XXXXXXXXXX",
  "type": "voice | image | text | interactive",
  "payload": {
    "voice": { "mediaUrl": "s3://...", "duration": 4 },
    "image": { "mediaUrl": "s3://...", "mimeType": "image/jpeg" },
    "text": { "body": "..." },
    "interactive": { "buttonId": "apply_thumbprint" }
  },
  "timestamp": "2026-02-15T09:41:00Z"
}
```

### Document Diagnosis Result (Textract + Bedrock → DynamoDB)

```json
{
  "userId": "hash_91XXXXXXXXXX",
  "diagnosisId": "diag_20260215_001",
  "documents": {
    "aadhaar": { "status": "verified", "confidence": 0.96, "name": "Ramesh Kumar", "dob": "1985-03-15" },
    "pan": { "status": "verified", "confidence": 0.94, "name": "Ramesh Kumar" },
    "bank": { "status": "mismatch", "confidence": 0.72, "name": "Ramesh K.", "field": "name" }
  },
  "healthReport": { "verified": 3, "mismatch": 1, "missing": 1 },
  "mismatches": [
    { "field": "name", "docA": "aadhaar", "valueA": "Ramesh Kumar", "docB": "bank", "valueB": "Ramesh K.", "severity": "high" }
  ],
  "correctionFormUrl": "s3://quintic-forms/correction_aadhaar_hash91XX.pdf"
}
```

### ONDC Catalog Submission (Bedrock → ONDC Gateway)

```json
{
  "sellerId": "quintic_seller_hash91XX",
  "product": {
    "title": "Banarasi Silk Saree",
    "description": "Handwoven pure silk with traditional Mughal motifs. Zari gold thread border. 6.5m length incl. blouse piece.",
    "category": "Textiles > Sarees > Silk",
    "price": { "value": 1500, "currency": "INR" },
    "images": ["s3://quintic-catalog/product_001.jpg"],
    "attributes": {
      "material": "Pure Silk",
      "technique": "Handloom",
      "origin": "Varanasi, UP"
    }
  }
}
```

---

## Proactive Push Engine — Event-Driven Architecture

```
┌──────────────────┐     ┌────────────────────┐     ┌──────────────────┐
│  Policy Updates   │────▶│  Amazon EventBridge │────▶│  Step Functions   │
│  (new schemes,    │     │  (Event Bus)        │     │  (re-evaluate     │
│   criteria change)│     │                     │     │   all users)      │
└──────────────────┘     └────────────────────┘     └────────┬─────────┘
                                                              │
┌──────────────────┐                                          ▼
│  Life Events      │     ┌────────────────────┐     ┌──────────────────┐
│  (birth, harvest, │────▶│  Kendra: re-match   │────▶│  WhatsApp Alert   │
│   season change)  │     │  user vs. schemes   │     │  "You qualify for │
└──────────────────┘     └────────────────────┘     │   ₹20,000!"       │
                                                     └──────────────────┘
```

**Trigger Sources:**
- Government RSS feeds / gazette notifications (polled daily)
- Seasonal calendar events (harvest cycles, fiscal year start)
- User-reported life events (voice: "mera baccha hua" → "I had a baby")

---

## Security Architecture

### Data Protection

| Layer | Mechanism |
|-------|-----------|
| Data at Rest | AES-256 encryption (S3, DynamoDB) |
| Data in Transit | TLS 1.3 (all API calls) |
| Aadhaar Compliance | UIDAI Virtual ID support; no raw Aadhaar storage after extraction |
| API Keys | AWS Secrets Manager with automatic rotation |
| Network | Amazon VPC with private subnets; NAT Gateway for outbound-only govt. API access |
| Authentication | Amazon Cognito user pools; WhatsApp phone number verification |
| Authorization | IAM roles with least-privilege; Lambda functions scoped per action group |
| Audit | CloudTrail logging for all API calls; DynamoDB Streams for data change audit |

### Threat Model

| Threat | Mitigation |
|--------|-----------|
| Document image interception | TLS 1.3 + S3 server-side encryption |
| Unauthorized scheme application | Biometric (thumbprint) confirmation required |
| Identity spoofing | Cognito device binding + phone number OTP |
| DDoS on WhatsApp webhook | AWS WAF rate limiting + CloudFront shield |
| Government API credential leak | Secrets Manager with auto-rotation; VPC-isolated Lambda |

---

## Scalability Plan

| Scale | Users | Architecture Change | Est. Monthly Cost |
|-------|-------|--------------------|--------------------|
| Pilot | 1,000 | Single-region, Kendra Dev Edition | ~$900 |
| Growth | 10,000 | Multi-AZ, DynamoDB auto-scaling | ~$1,600 |
| Scale | 100,000 | Multi-region, Kendra Enterprise, reserved capacity | ~$4,000 |
| National | 1,000,000+ | Federated state-level deployments, Bedrock provisioned throughput | Custom pricing |

**Key Scaling Decisions:**
- DynamoDB on-demand mode handles unpredictable rural usage patterns (seasonal spikes during harvest/subsidy cycles)
- Step Functions Standard Workflows (not Express) for durability at the cost of slightly higher per-transition pricing
- Kendra scales from Developer Edition (pilot) to Enterprise Edition (production) without reindexing

---

## Estimated Implementation Cost (10,000 Users)

| AWS Service | Purpose | Monthly Usage | Est. Cost/mo |
|-------------|---------|---------------|-------------|
| Amazon Bedrock (Claude Sonnet 4.5) | AI reasoning, Document Diagnosis, policy translation | ~500K input + 200K output tokens | $450 |
| Amazon Textract | Aadhaar, PAN, Bank passbook OCR | ~30,000 pages/month | $45 |
| Amazon Kendra | Policy RAG — index 5,000+ govt. scheme PDFs | 1 Developer Edition index | $810 |
| AWS Step Functions | Workflow orchestration, durable state | ~100K state transitions | $2.50 |
| AWS Transcribe | Voice-to-text for vernacular input | ~5,000 minutes audio | $120 |
| Amazon Pinpoint + WhatsApp API | WhatsApp Business messaging gateway | ~50,000 messages | $75 |
| DynamoDB + S3 + CloudFront | Session state, Identity Vault, CDN | ~50GB storage, 1M requests | $35 |
| Lambda + EventBridge + Cognito | Compute, event triggers, auth | ~200K invocations | $15 |
| VPC + NAT Gateway + WAF | Secure networking, firewall for govt. API calls | Always-on + ~10GB data processed | $45 |
| Bhashini API (External) | Regional dialect translation (22 languages) | ~10,000 translation requests | Free* |
| **TOTAL** | | | **~$1,600/mo** |

*\*Bhashini is government-funded under India's National Language Translation Mission.*

**Per-user cost:** ₹13/user/month (~$0.16) at 10K users → ₹4/user/month at 100K users.

---

## Technology Justification

| Component | Chosen Technology | Why (The "Painkiller" Choice) | Alternative Considered | Why Rejected |
|-----------|-------------------|-------------------------------|----------------------|-------------|
| Orchestration | AWS Step Functions | Manages long-running workflows (3-day govt API waits). Retries on crash. Durable state. | AWS Lambda chaining | No built-in state persistence; fails on long waits |
| AI Brain | Amazon Bedrock (Claude Sonnet 4.5) | Industry-standard reasoning. Handles document diagnosis + legal policy → dialect translation | OpenAI GPT-4 | Not available on AWS Bedrock; cross-cloud latency |
| Document OCR | Amazon Textract | Specifically trained on Indian ID documents. Handles low-quality phone photos | Google Document AI | Requires GCP; no native AWS integration |
| Policy Search | Amazon Kendra | Enterprise search with contextual understanding of eligibility | OpenSearch + embeddings | Poor performance on dense legal/policy documents |
| Voice/Language | AWS Transcribe + Bhashini API | Transcribe for audio processing; Bhashini for 22 Indian dialect nuances | Google Speech-to-Text | Bhashini is government-mandated for Indian languages |
| Interface | Amazon Pinpoint / WhatsApp | Universal rural penetration. Async interaction matches farming work patterns | Custom mobile app | Requires installation, smartphone storage, data plan |

---

## Monitoring & Observability

| Metric | Tool | Alert Threshold |
|--------|------|----------------|
| Workflow success rate | Step Functions console + CloudWatch | < 95% → P1 alert |
| Document OCR confidence | Custom CloudWatch metric | Average < 80% → review Textract pipeline |
| Scheme match accuracy | Bedrock evaluation logs | False positive rate > 10% → retune Kendra index |
| WhatsApp delivery rate | Pinpoint analytics | < 98% delivery → check Pinpoint quotas |
| API latency (govt portals) | CloudWatch + X-Ray | p99 > 30s → enable retry with backoff |
| DLQ depth | SQS CloudWatch metric | > 50 messages → P2 alert; manual investigation |

---

## Future Roadmap

| Phase | Timeline | Feature |
|-------|----------|---------|
| V1.0 | Month 1-3 | Core workflow: Onboarding → Document Doctor → Welfare matching → ONDC listing |
| V1.1 | Month 4-5 | Dashboard, push alerts, life-event monitoring |
| V2.0 | Month 6-8 | Loan/insurance marketplace integration (using same Identity Vault) |
| V2.1 | Month 9-10 | Multi-user household support (family mode) |
| V3.0 | Month 12+ | State government partnerships for direct portal API integration (replacing screen scraping) |